<!DOCTYPE html>
<html data-bs-theme="light" lang="en-US" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ===============================================--><!--    Document Title--><!-- ===============================================-->
  <title>LunarInspector</title>

  <!-- ===============================================--><!--    Favicons--><!-- ===============================================-->
  <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicons/favicon-16x16.png">
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicons/favicon.ico">
  <link rel="manifest" href="assets/img/favicons/manifest.json">
  <meta name="msapplication-TileImage" content="assets/img/favicons/mstile-150x150.png">
  <meta name="theme-color" content="#ffffff">

  <!-- ===============================================--><!--    Stylesheets--><!-- ===============================================-->
  <link rel="stylesheet" href="vendors/swiper/swiper-bundle.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&amp;family=Rubik:ital,wght@0,300..900;1,300..900family=Rubik:ital,wght@0,300..900;1,300..900&amp;display=swap"
    rel="stylesheet">
  <link href="assets/css/theme.min.css" rel="stylesheet" id="style-default">
  <link href="assets/css/user-rtl.min.css" rel="stylesheet" id="user-style-rtl">
  <link href="assets/css/user.min.css" rel="stylesheet" id="user-style-default">
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <style>
    video {
      border-radius: 15px;
      min-width: 640px;
      min-height: 480px;
      max-width: 640px;
      max-height: 480px;
      background-color: gray;
    }

    #preview {
      border-radius: 15px;
      min-width: 640px;
      min-height: 480px;
      max-width: 640px;
      max-height: 480px;
      background-color: rgb(16, 16, 16);
      /*display: none;*/
    }

    #errorMessage {
      display: none;
      color: red;
      font-size: 18px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }


    #webcam {
      display: none;
    }
  </style>
  <!-- ===============================================--><!--    Main Content--><!-- ===============================================-->
  <main class="main" id="top">
    <div class="content">
      <nav class="navbar navbar-expand-md fixed-top" id="navbar"
        data-navbar-soft-on-scroll="data-navbar-soft-on-scroll">
        <div class="container-fluid px-0"><a href="/"><img class="navbar-brand w-75 d-md-none"
              src="assets/img/logos/logo.png" alt="logo" /></a><a class="navbar-brand fw-bold d-none d-md-block"
            href="index.html">LunarInspector</a><a class="btn btn-primary btn-sm ms-md-x1 mt-lg-0 order-md-1 ms-auto"
            href="#">Inspeccionar mi lunar </a><button class="navbar-toggler border-0 pe-0" type="button"
            data-bs-toggle="collapse" data-bs-target="#navbar-content" aria-controls="navbar-content"
            aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
          <div class="collapse navbar-collapse justify-content-md-end" id="navbar-content"
            data-navbar-collapse="data-navbar-collapse">
            <ul class="navbar-nav gap-md-2 gap-lg-3 pt-x1 pb-1 pt-md-0 pb-md-0" data-navbar-nav="data-navbar-nav">
              <li class="nav-item"> <a class="nav-link lh-xl" href="index.html#home">Inicio</a></li>
              <li class="nav-item"> <a class="nav-link lh-xl" href="index.html#about">Sobre el proyecto</a></li>
              <li class="nav-item"> <a class="nav-link lh-xl" href="index.html#service">Modelo</a></li>
              <li class="nav-item"> <a class="nav-link lh-xl" href="index.html#pricing">Colabora</a></li>
              <li class="nav-item"> <a class="nav-link lh-xl" href="index.html#contact">Contacto</a></li>
            </ul>
          </div>
        </div>
      </nav>
      <div data-bs-target="#navbar" data-bs-spy="scroll" tabindex="0">
        <section class="hero-section overflow-hidden position-relative z-0 mb-4 mb-lg-0" id="home">
          <div class="hero-background">
            <div class="container">
              <div class="row gy-4 gy-md-8 pt-0 pt-lg-0">
                <div class="col-lg-6 text-center text-lg-start" style="margin-top: -30px;">
                  <h1 class="fs-2 fs-lg-1 text-white fw-bold mb-2 mb-lg-x1 lh-base mt-3 mt-lg-0" style="z-index: 10;">
                    LunarInspector <span class="text-nowrap">scanner</span></h1>
                  <p class="fs-8 text-white mb-3 mb-lg-4 lh-lg">Sube o captura ahora tu imágen. Y recibe tu predicción
                    en linea</p>
                  <div class="d-flex justify-content-center justify-content-lg-start">
                    <label for="fileInput" class="btn btn-primary btn-lg lh-xl mb-4 mb-md-5 mb-lg-7 mr-3"
                      href="#uploadImage"><i class="bi bi-file-earmark-image"></i> Seleccionar Foto</label>&nbsp;&nbsp;
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <button id="captureImage" class="btn btn-primary btn-lg lh-xl mb-4 mb-md-5 mb-lg-7 ml-3">Activar
                      cámara</button>
                  </div>
                  <input type="file" id="uploadImage" accept="image/*" hidden>

                  <br><a href="">Desactivar cámara</a>
                  <p class="mb-x1 fs-10 button-text text-uppercase fw-bold lh-base text-300">Descarga nuestra APP (En
                    desarrollo)</p>
                  <div
                    class="d-flex flex-wrap justify-content-center justify-content-lg-start gap-2 position-relative z-2">
                    <a class="border-0 p-0 bg-transparent cursor-pointer rounded-1" href="#!"> <img class="img-fluid"
                        src="assets/img/logos/App_Store.webp" alt="assets/img/logos/App_Store.webp" /></a><a
                      class="border-0 p-0 bg-transparent cursor-pointer rounded-1" href="#!"> <img class="img-fluid"
                        src="assets/img/logos/Play_Store.webp" alt="assets/img/logos/Play_Store.webp" /></a>
                  </div>
                </div>
                <div class="col-lg-6 position-lg-relative" style="margin-top: -30px;">
                  <button id="takePhoto" style="display:none;" class="btn btn-primary btn-lg text-center">Tomar
                    Foto</button>
                  <!-- VIDEO WEBCAM-->
                  <button id="sendImage" class="btn btn-primary btn-lg lh-xl mt-2 ml-3 text-center">Enviar e
                    Inspeccionar mi lunar</button>

                  <div class="position-lg-absolute z-1 text-center" id="videoContainer">
                    <video id="webcam" autoplay playsinline></video>
                    <!-- Canvas oculto para capturar la imagen de la webcam -->
                    <canvas id="canvas" style="display:none;"></canvas>
                    <!-- Imagen de previsualización -->
                    <img id="preview" src="" alt="Previsualización de la imagen">
                    <div id="errorMessage" style="color: black;">No se puede acceder a la cámara. Por favor, verifica
                      los permisos o intenta en otro dispositivo.</div>
                    <div class="position-absolute dots d-none d-md-block"> <img class="img-fluid w-50 w-lg-75"
                        src="assets/img/illustrations/Dots.webp" alt="" /></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="position-absolute bottom-0 start-0 end-0 z-1"><img class="wave mb-md-n2"
              src="assets/img/illustrations/Wave.svg" alt="" />
            <div class="bg-white py-2 py-md-5"></div>
          </div>
        </section>



        <script>

          // Referencias a los elementos
          const videoElement = document.getElementById('webcam');
          const canvasElement = document.getElementById('canvas');
          const previewImage = document.getElementById('preview');
          const uploadImage = document.getElementById('fileInput');
          const captureButton = document.getElementById('captureImage');
          const takePhotoButton = document.getElementById('takePhoto');
          const errorMessage = document.getElementById('errorMessage');
          const sendImage = document.getElementById('sendImage');
          var fileToUpload = null;


          //Para mostrar el botón enviar

          showPostButton();
          // Manejar selección de imagen desde el dispositivo
          uploadImage.addEventListener('change', function (event) {
            console.log("Event trigger upload");
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                previewImage.src = e.target.result;
                fileToUpload = e.target.result;
                previewImage.style.display = 'block';  // Mostrar la previsualización
                showPostButton();
                stopWebcam();  // Detener la cámara si está activa
              };
              reader.readAsDataURL(file);  // Leer el archivo como Data URL
            }
          });

          // Manejar captura de imagen con la webcam
          captureButton.addEventListener('click', function () {
            // Solicitar acceso a la webcam
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
              navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                  fileToUpload = null;
                  showPostButton();
                  videoElement.style.display = 'block';
                  takePhotoButton.style.display = '';
                  videoElement.srcObject = stream;
                  errorMessage.style.display = 'none';  // Ocultar mensaje de error si funciona
                  previewImage.style.display = 'none';
                })
                .catch(function (error) {
                  console.error("Error al acceder a la cámara: ", error);
                  videoElement.style.display = 'none';
                  errorMessage.style.display = 'block';  // Mostrar mensaje de error
                });
            } else {
              videoElement.style.display = 'none';
              errorMessage.style.display = 'block';  // Mostrar mensaje de error
            }
          });

          // Tomar foto y mostrar en el elemento img
          takePhotoButton.addEventListener('click', function () {
            fileToUpload = null;
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageDataURL = canvasElement.toDataURL('image/png');
            previewImage.src = imageDataURL;
            fileToUpload = imageDataURL;
            showPostButton();
            // Detener la webcam después de tomar la foto
            stopWebcam();
          });

          // Función para detener la webcam
          function stopWebcam() {
            const stream = videoElement.srcObject;
            if (stream) {
              const tracks = stream.getTracks();
              tracks.forEach(track => track.stop());
            }
            videoElement.style.display = 'none';
            takePhotoButton.style.display = 'none';
            previewImage.style.display = '';
          }


          sendImage.addEventListener('click', function (event) {
            console.log("click upload");
            let url = "http://127.0.0.1:8000/upload_image/"

            let datos = {
              'file': undefined,
              'user': "juanito",
              'lat': "19.4",
              'lon': "-99.5",
              'polution': "3.2",
              'state': "1",
              'uv': "5"
            }


            if (fileToUpload) {
              // Convertir la imagen base64 a un Blob
              const blob = dataURItoBlob(fileToUpload);

              // Crear un formulario para enviar la imagen
              const formData = new FormData();
              formData.append('file', blob, randomName());

              formData.append('user', datos.user);
              formData.append('lat', datos.lat);
              formData.append('lon', datos.lon);
              formData.append('polution', datos.polution);
              formData.append('state', datos.state);
              formData.append('uv', datos.uv);

              // Enviar la imagen al servidor usando fetch
              fetch(url, {
                method: 'POST',
                body: formData
              })
                .then(response => response.json())
                .then(data => {
                  console.log('Éxito:', data);
                  if(data.skin_cancer == "benigno"){
                    allOK();
                  }

                  if(data.skin_cancer == "maligno"){
                    allBad(data.disease_type);
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('Error al enviar la imagen');
                });
            } else {
              alert('No hay imagen para enviar');
            }
          });

          function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
              ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
          }

          function randomName() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let resultado = '';
            for (let i = 0; i < 16; i++) {
              const indiceAleatorio = Math.floor(Math.random() * caracteres.length);
              resultado += caracteres.charAt(indiceAleatorio);
            }
            return resultado + ".png";
          }

          function showPostButton() {
            if (fileToUpload) {
              sendImage.hidden = false;
            } else {
              sendImage.hidden = true;
            }
          }


          //====================================== Handle the response

          function allOK() {
            Swal.fire({
              title: 'LunarInspector',
              icon: 'success',
              html: '<h1 class="mb-2 lh-lg ls-1">Su lunar es <span style="color:green">BENIGNO<span></h1>'
                
                + '<br>Aún así recomendamos consultar con un médico especialista',
              confirmButtonText: 'CONFIRMAR'
            })
          }

          function allBad(dst) {
            console.log(dst)
            dst_string = "";
            for(let i in dst){
              li = dst[i];
              console.log(li.name)
              dst_string += "<p>Tipo:"+ li.name +", Probabilidad:"+li.percent.toString().substr(0,4)+"%</p>";
            }
            //dst_string += "<ul>";
            Swal.fire({
              title: 'LunarInspector',
              icon: 'warning',
              html: '<h1 class="mb-2 lh-lg ls-1">Su lunar podría ser <span style="color:red">MALIGNO<span></h1>'
                + '<br>La probalidad de que sea una de las siguientes enfermedades es:<br><br>'+dst_string
                + '<br><br><b>Es altamente recomendable que veas un médico especialista</b>',
              confirmButtonText: 'CONFIRMAR'
            })
          }



        </script>

      </div><button
        class="btn scroll-to-top text-white rounded-circle d-flex justify-content-center align-items-center bg-primary"
        data-scroll-top="data-scroll-top"><span class="uil uil-angle-up"></span></button>
      <footer class="pt-7 pt-lg-8">
        <div class="container">
          <div class="row gy-4 g-md-3 border-bottom pb-8 pb-lg-9 justify-content-center">
            <div class="col-6 col-md-3">
              <p class="mb-2 lh-lg ls-1">LunarInspector</p>
              <ul class="list-unstyled text-1100">
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#about">Sobre el proyecto</a></li>
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#service"> Modelo</a></li>
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#pricing">Colabora</a></li>
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#contact">Contacto</a></li>
              </ul>
            </div>
            <!--div class="col-6 col-md-3">
                <p class="mb-2 lh-lg">Product</p>
                <ul class="list-unstyled text-1100">
                  <li class="mb-1"> <a class="ls-1 lh-xl" href="#!">Features</a></li>
                  <li class="mb-1"> <a class="ls-1 lh-xl" href="#!"> Pricing</a></li>
                  <li class="mb-1"> <a class="ls-1 lh-xl" href="#!"> News</a></li>
                  <li class="mb-1"> <a class="ls-1 lh-xl" href="#!"> Help desk</a></li>
                  <li class="mb-1"><a class="ls-1 lh-xl" href="#!"> Support</a></li>
                </ul>
              </div-->
            <div class="col-6 col-md-3">
              <p class="mb-2 lh-lg"> Legal</p>
              <ul class="list-unstyled text-1100">
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#!">Privacidad</a></li>
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#!"> Terminos & Condiciones</a></li>
                <li class="mb-1"> <a class="ls-1 lh-xl" href="#!"> Tratamiento de datos</a></li>
              </ul>
            </div>
            <div class="col-6 col-md-3 d-md-flex flex-column align-items-md-end pe-md-0">
              <div>
                <p class="mb-2 lh-lg"> Descarga la App</p>
                <div class="mb-1 mb-lg-2"> <a class="border-0 p-0 bg-transparent cursor-pointer rounded-1" href="#!">
                    <img class="img-fluid" src="assets/img/logos/App_Store.webp"
                      alt="assets/img/logos/App_Store.webp" /></a></div><a
                  class="border-0 p-0 bg-transparent cursor-pointer rounded-1" href="#!"> <img class="img-fluid"
                    src="assets/img/logos/Play_Store.webp" alt="assets/img/logos/Play_Store.webp" /></a>
              </div>
            </div>
          </div>
          <div class="row gy-2 py-3 justify-content-center justify-content-md-between">
            <div class="col-auto ps-0">
              <p class="text-center text-md-start lh-xl text-1100"> © 2024 Copyright, <a class="fw-semi-bold"
                  href="https://themewagon.com/">Lunarinspector </a>❤️</p>
            </div>
            <div class="col-auto pe-0"><a class="icons fs-8 me-3 me-md-0 ms-md-3 cursor-pointer" href="#!"><span
                  class="uil uil-twitter"> </span></a><a class="icons fs-8 me-3 me-md-0 ms-md-3 cursor-pointer"
                href="#!"><span class="uil uil-instagram"></span></a><a
                class="icons fs-8 me-3 me-md-0 ms-md-3 cursor-pointer" href="#!"><span class="uil uil-linkedin">
                </span></a></div>
          </div>
        </div>
      </footer>
    </div>
  </main>
  <!-- ===============================================--><!--    End of Main Content--><!-- ===============================================-->



  <!-- ===============================================--><!--    JavaScripts--><!-- ===============================================-->
  <script src="vendors/popper/popper.min.js"></script>
  <script src="vendors/bootstrap/bootstrap.min.js"></script>
  <script src="vendors/is/is.min.js"></script>
  <script src="vendors/countup/countUp.umd.js"></script>
  <script src="vendors/swiper/swiper-bundle.min.js"></script>
  <script src="vendors/lodash/lodash.min.js"></script>
  <!--script src="https://polyfill.io/v3/polyfill.min.js?features=window.scroll"></script-->
  <script src="assets/js/theme.js"></script>
</body>

</html>